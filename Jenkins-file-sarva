pipeline {
    agent any
     parameters {
        string(name: 'IMAGE_NAME', defaultValue: 'test-image', description: 'Please provide the image name')
		string(name: 'RepoName', defaultValue: 'Sarvabhowma1995/Demo.git', description: 'Please provide the image name')

     }
	stages{
	    stage('clone the repo'){
		 steps{
		   git changelog: false, credentialsId: 'github', poll: false, url: 'https://github.com/${params.RepoName}'
		 }
		}
	    stage('Maven Clean install'){
	        steps{
		        script{
                    sh "mvn clean install"
		        }
		    }
	    }
		stage('Test the code with maven'){
	        steps{
		        script{
                    sh '''
					mvn test
					result=$?
					if [ $result -ne 0 ]; then
					echo "test failres are present"
					exit $result
					fi
					'''
		        }
		    }
	    }
		stage('Build Docker Image'){
		    steps{
			    sh 'docker build -t ${params.IMAGE_NAME} .'
			}
		}
	    stage('Push Docker Image'){
	        steps{
					withCredentials([usernamePassword(credentialsId: 'docker-creds', passwordVariable: 'pass', usernameVariable: 'user')]) {
						sh "docker login -u ${user} -p ${pass}"
		        }
		        sh 'docker push ${IMAGE_NAME}'
	        }
	    }
		stage('Deploy the application'){
		    steps{
		         sh 'docker-compose up -d'
			 
			}
		}
	}
}
